"""Vulnerability scanner for container images"""

import asyncio
import logging
import subprocess
import json
from pathlib import Path
from typing import List, Optional, Union

from netsec_container.core.results import Vulnerability

logger = logging.getLogger(__name__)


class VulnerabilityScanner:
    """Scan container images for vulnerabilities"""
    
    def __init__(self):
        self.name = "Vulnerability Scanner"
        # Use Trivy as backend (lightweight, fast)
        self.use_trivy = self._check_trivy_available()
        if not self.use_trivy:
            logger.warning("Trivy not found. Install for better vulnerability scanning: https://github.com/aquasecurity/trivy")
    
    def _check_trivy_available(self) -> bool:
        """Check if Trivy is available"""
        try:
            result = subprocess.run(
                ["trivy", "--version"],
                capture_output=True,
                timeout=5
            )
            return result.returncode == 0
        except (FileNotFoundError, subprocess.TimeoutExpired):
            return False
    
    async def scan_async(
        self,
        image: str,
        image_path: Optional[Union[str, Path]] = None,
    ) -> List[Vulnerability]:
        """
        Scan image for vulnerabilities asynchronously
        
        Args:
            image: Container image name/tag
            image_path: Path to saved image tar file
            
        Returns:
            List of Vulnerability objects
        """
        if self.use_trivy:
            return await self._scan_with_trivy(image, image_path)
        else:
            # Fallback to basic scanning
            return await self._scan_basic(image, image_path)
    
    async def _scan_with_trivy(
        self,
        image: str,
        image_path: Optional[Union[str, Path]] = None,
    ) -> List[Vulnerability]:
        """Scan using Trivy"""
        vulnerabilities = []
        
        try:
            # Build Trivy command
            cmd = [
                "trivy", "image",
                "--format", "json",
                "--quiet",
                "--no-progress",
            ]
            
            if image_path:
                cmd.extend(["--input", str(image_path)])
            else:
                cmd.append(image)
            
            # Run Trivy
            process = await asyncio.create_subprocess_exec(
                *cmd,
                stdout=asyncio.subprocess.PIPE,
                stderr=asyncio.subprocess.PIPE,
            )
            
            stdout, stderr = await process.communicate()
            
            if process.returncode != 0:
                logger.error(f"Trivy scan failed: {stderr.decode()}")
                return vulnerabilities
            
            # Parse Trivy JSON output
            try:
                trivy_data = json.loads(stdout.decode())
                
                for result in trivy_data.get("Results", []):
                    for vuln in result.get("Vulnerabilities", []):
                        vulnerability = Vulnerability(
                            cve_id=vuln.get("VulnerabilityID", "UNKNOWN"),
                            package=vuln.get("PkgName", ""),
                            version=vuln.get("InstalledVersion", ""),
                            severity=self._normalize_severity(vuln.get("Severity", "UNKNOWN")),
                            score=float(vuln.get("CVSS", {}).get("nvd", {}).get("V3Score", 0.0)),
                            description=vuln.get("Title", vuln.get("Description", "")),
                            fixed_version=vuln.get("FixedVersion"),
                            exploit_available=False,  # Would need additional data source
                        )
                        vulnerabilities.append(vulnerability)
            except json.JSONDecodeError as e:
                logger.error(f"Failed to parse Trivy output: {e}")
        
        except Exception as e:
            logger.error(f"Trivy scan error: {e}", exc_info=True)
        
        return vulnerabilities
    
    async def _scan_basic(
        self,
        image: str,
        image_path: Optional[Union[str, Path]] = None,
    ) -> List[Vulnerability]:
        """Basic vulnerability scanning (fallback)"""
        # This would implement a basic scanner without Trivy
        # For now, return empty list
        logger.warning("Basic vulnerability scanning not implemented. Install Trivy for full scanning.")
        return []
    
    def _normalize_severity(self, severity: str) -> str:
        """Normalize severity to our standard levels"""
        severity_lower = severity.lower()
        if severity_lower in ["critical", "cr√≠tical"]:
            return "critical"
        elif severity_lower in ["high", "important"]:
            return "high"
        elif severity_lower in ["medium", "moderate"]:
            return "medium"
        elif severity_lower in ["low", "minor"]:
            return "low"
        else:
            return "info"
